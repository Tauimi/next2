# Руководство по деплою TechnoMart на Vercel

## Подготовка к деплою

### 1. Создание аккаунта на Vercel
1. Перейдите на [vercel.com](https://vercel.com)
2. Зарегистрируйтесь через GitHub (рекомендуется)
3. Подтвердите аккаунт

### 2. Подготовка репозитория
1. Убедитесь, что ваш проект находится в Git репозитории
2. Если нет, инициализируйте Git:
```bash
git init
git add .
git commit -m "Initial commit"
```
3. Загрузите проект на GitHub:
   - Создайте новый репозиторий на GitHub
   - Добавьте remote и push:
```bash
git remote add origin https://github.com/ваш-username/ваш-репозиторий.git
git branch -M main
git push -u origin main
```

## Настройка базы данных на Vercel

### 1. Создание Prisma Postgres базы данных
1. Войдите в панель Vercel
2. Перейдите в раздел **Storage**
3. Нажмите **Create Database**
4. Выберите **Prisma Postgres**
5. Укажите имя базы данных (например, `technomart-db`)
6. Выберите регион (рекомендуется ближайший к вашим пользователям)
7. Нажмите **Create**

### 2. Получение данных подключения
После создания базы данных:
1. Перейдите в раздел **Settings** вашей базы данных
2. Найдите раздел **Connection String**
3. Скопируйте строку подключения в формате Prisma:
```
prisma://accelerate.prisma-data.net/?api_key=ваш_api_ключ
```

**Важно:** Vercel Prisma Postgres использует Prisma Accelerate, поэтому URL будет в формате `prisma://` а не `postgres://`

## Деплой приложения

### 1. Создание проекта на Vercel
1. В панели Vercel нажмите **New Project**
2. Выберите ваш GitHub репозиторий
3. Vercel автоматически определит, что это Next.js проект

### 2. Настройка переменных окружения
В разделе **Environment Variables** добавьте:

```bash
# Обязательные переменные для Vercel Prisma Postgres
DATABASE_URL=prisma://accelerate.prisma-data.net/?api_key=ваш_api_ключ
NEXTAUTH_SECRET=сгенерированный_секретный_ключ
NEXTAUTH_URL=https://ваш-домен.vercel.app

# Дополнительные переменные
NODE_ENV=production
```

**Важно:** Используйте точно ту строку подключения, которую предоставляет Vercel в настройках вашей Prisma Postgres базы данных.

**Генерация NEXTAUTH_SECRET:**
```bash
# В локальной консоли выполните:
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 3. Настройка Build команд
Vercel автоматически настроит команды, но можно проверить:
- **Build Command**: `npm run build`
- **Output Directory**: `.next`
- **Install Command**: `npm install`

### 4. Деплой
Нажмите **Deploy** и дождитесь завершения процесса.

## Инициализация базы данных

### 1. Автоматическая инициализация
После успешного деплоя:
1. Перейдите на ваш сайт: `https://ваш-проект.vercel.app`
2. База данных автоматически инициализируется при первом запуске
3. Создайтесь первый аккаунт - он станет администратором

### 2. Проверка работоспособности
1. Откройте `https://ваш-проект.vercel.app/api/health`
2. Должен вернуться JSON с информацией о подключении к БД
3. Зарегистрируйтесь на сайте для проверки работы

## Настройка домена (опционально)

### 1. Добавление собственного домена
1. В настройках проекта Vercel перейдите в **Domains**
2. Добавьте ваш домен
3. Настройте DNS записи согласно инструкциям Vercel

### 2. Обновление NEXTAUTH_URL
Если используете собственный домен:
1. В **Environment Variables** обновите `NEXTAUTH_URL`
2. Переdeployите проект

## Мониторинг и обслуживание

### 1. Логи и аналитика
- Логи доступны в разделе **Functions** → **View Function Logs**
- Аналитика в разделе **Analytics**

### 2. Обновления
Для обновления кода:
1. Внесите изменения в локальный репозиторий
2. Сделайте commit и push в GitHub
3. Vercel автоматически переdeployит проект

### 3. Бэкапы базы данных
В настройках базы данных Vercel есть опции для создания бэкапов.

## Возможные проблемы и решения

### 1. Ошибки подключения к БД
- Проверьте правильность DATABASE_URL
- Убедитесь, что используется формат `prisma://` для Vercel Prisma Postgres
- Проверьте правильность API ключа в строке подключения
- Убедитесь, что в проекте настроен Prisma Client для работы с Accelerate

### 2. Ошибки аутентификации
- Проверьте NEXTAUTH_SECRET (должен быть одинаковым между деплоями)
- Убедитесь, что NEXTAUTH_URL соответствует вашему домену

### 3. Проблемы с миграциями
- Prisma автоматически применит миграции при деплое
- Если есть проблемы, проверьте логи в Vercel

### 4. Превышение лимитов
- Бесплатный план Vercel имеет лимиты на:
  - 100GB передачи данных
  - 100 функций в час
  - 10 секунд выполнения функции
- При превышении рассмотрите переход на Pro план

## Стоимость

### Vercel
- **Hobby (бесплатно)**: подходит для небольших проектов
- **Pro ($20/месяц)**: для коммерческих проектов
- **Enterprise**: для крупных компаний

### Vercel Prisma Postgres
- **Hobby**: 1M запросов в месяц, 1GB хранилища (бесплатно)
- **Pro**: 10M запросов в месяц, 10GB хранилища (от $20/месяц)
- **Дополнительные запросы**: $0.30 за 1M запросов
- **Дополнительное хранилище**: $0.25/GB в месяц

## Заключение

После выполнения всех шагов у вас будет полностью рабочий интернет-магазин TechnoMart, доступный по всему миру через CDN Vercel с надежной Prisma Postgres базой данных, оптимизированной через Prisma Accelerate.

Первый зарегистрированный пользователь автоматически получает права администратора и может управлять товарами через админ-панель по адресу `/admin`.

## Дополнительная информация о Prisma Postgres

Vercel Prisma Postgres включает:
- **Prisma Accelerate** - глобальное кэширование и connection pooling
- **Автоматическое масштабирование** - база данных автоматически адаптируется под нагрузку
- **Глобальная доступность** - данные реплицируются в регионах для быстрого доступа
- **Встроенная безопасность** - SSL/TLS шифрование и изоляция данных

## Совместимость проекта

Проект TechnoMart настроен для работы с обеими вариантами:

### Локальная разработка
- Используйте обычную PostgreSQL с CONNECTION_STRING в формате `postgresql://`
- Проект автоматически определит тип подключения и использует стандартный Prisma Client

### Vercel деплой
- Используйте Prisma Postgres с CONNECTION_STRING в формате `prisma://`
- Проект автоматически подключит Prisma Accelerate extension для оптимизации

### Автоматическое определение
```typescript
// lib/prisma.ts автоматически определяет тип подключения:
if (process.env.DATABASE_URL?.startsWith('prisma://')) {
  // Использует Prisma Accelerate
} else {
  // Использует обычный Prisma Client
}
``` 